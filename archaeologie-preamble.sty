\RequirePackage{iftex}
\ifPDFTeX
  \RequirePackage[utf8]{inputenc}
  \RequirePackage[T1]{fontenc}
  \RequirePackage{lmodern}
\else
    \ifXeTeX
    \RequirePackage{fontspec}
		\def\compiler{\hologo{XeLaTeX}}
  \else
	  \RequirePackage{fontspec}
    \RequirePackage{luatextra}
    \RequirePackage{luaotfload}
	\def\compiler{\hologo{LuaLaTeX}}
\fi
  \defaultfontfeatures{Ligatures=TeX}
\fi
\listfiles
\RequirePackage{libertine}
\defaultfontfeatures[AnonymousPro]
  {
    Extension      = .ttf                       ,
    BoldFont       = AnonymousPro-Bold          ,
    ItalicFont     = AnonymousPro-BoldItalic    ,
    BoldItalicFont = AnonymousPro-Italic        ,
    UprightFont    = AnonymousPro-Regular       ,
  }
\setmonofont[Scale= MatchLowercase]{AnonymousPro}
\setmainfont[Numbers = {Monospaced, OldStyle}]{Libertinus Serif}
%\setsansfont{Libertinus Sans}
\setmainfont[
%  Scale       = 0.95,
%  Numbers  = {OldStyle},
  Numbers={Proportional,OldStyle},
% BoldItalicFont = Gentium Book Basic Bold Italic,
  Ligatures   = TeX,
  BoldFont={Gentium Basic Bold},
% BoldFont    = GenBasB,
%  BoldFont={Gentium Basic Bold},
]{Gentium Plus}

\RequirePackage{xr-hyper}
\RequirePackage{url}
\RequirePackage{xspace}


\RequirePackage[
	backend=biber,
%	backref,
style=/Users/lukascbossert/Documents/github/biblatex-archaeologie/archaeologie,
	lstpublishers,
	lstlocations,
	lstabbrv,
%	initials=false,
]{biblatex}
\renewcommand\bibfont{\normalfont\footnotesize}
\RequirePackage{metalogo}
\RequirePackage{hologo}
\RequirePackage{babel}
\RequirePackage{coolthms}


\RequirePackage{chngcntr}

\RequirePackage[
  autostyle=true,%
]{csquotes}
\RequirePackage{multicol}
  \setlength{\columnsep}{1.5cm}
  \setlength{\columnseprule}{0.2pt}

\RequirePackage{xcolor}
\definecolor{codeblue}{RGB}{0,65,137}
\definecolor{codegreen}{RGB}{147,193,26}
\definecolor{codegray}{rgb}{0.5,0.5,0.5}
\definecolor{codepurple}{rgb}{0.58,0,0.82}
\definecolor{backcolour}{rgb}{0.95,0.95,0.92}


\RequirePackage[
	headsepline,
	footsepline,
%	plainfootsepline,
%markcase=upper,
automark,
draft=false,
]{scrlayer-scrpage}
\pagestyle{scrheadings}
\clearscrheadfoot
\ihead{\normalfont\footnotesize \texttt{bib}\LaTeX-style \texttt{archaeologie \archaeologieversion} \copyright\ by Lukas C. Bossert | Johannes Friedl}%
\rofoot{\normalfont\footnotesize  \textbf{\sffamily \thepage}}
\lofoot{\normalfont\footnotesize  \href{http://www.biblatex-archaeologie.de}{biblatex-archaeologie.de}}

\RequirePackage[%
%  flushmargin, %
%  marginal,
  ragged,%
  hang, %
  bottom%
]{footmisc}

\RequirePackage{marginnote,frame}
\RequirePackage{tabto}
\RequirePackage{ifthen,xstring}

\newcommand\archversion[2][0pt]{\leavevmode%
  \tabto*{\dimexpr\linewidth+10pt}\smash{\raisebox{%
  \dimexpr.2\ht\strutbox+#1}{\parbox[t]{2.5cm}{%
    \small%
    \raggedright%
     \frame{v.  \IfSubStr{\archaeologieversion}{#2}{     \color{codepurple}\bfseries }{}#2}
     }}}\tabto*{\TabPrevPos}%
}

\RequirePackage{enumitem}
\setlist{nosep}
\setlength{\parindent}{0pt}
\setlength{\parskip}{6pt plus 2pt minus 2pt}
\setenumerate[1]{label=(\alph*),leftmargin=*,nolistsep,parsep=\parskip}
\RequirePackage{changepage}
\makeindex

\defbibheading{empty}{}
\addbibresource{archaeologie-examples.bib}
\RequirePackage{caption}

\RequirePackage[%
  skins,%
  listings,%
  breakable,%
]{tcolorbox}
\lstMakeShortInline{|}

\newtcblisting[
  auto counter,
  list inside=bibexample,
%  number within=subsection,
  crefname={Example}{Examples}
]{bibexample}[2][]{%
  listing only,
  breakable,
  top=0.5pt,
  bottom=0.5pt,
  colback=codegreen!10,
  colframe=codegreen,
    left=5pt,
    right=5pt,
    sharp corners,
  boxrule=0pt,
  bottomrule=2pt,
  toprule=2pt,
  enhanced jigsaw,
  listing options={%style=tcblatex,
    numbers=left,
    numberstyle=\small\color{codeblue},
    moredelim={[is][keywordstyle]{@@}{@@}},
        basicstyle=\small\ttfamily,
    breaklines=true,
    breakautoindent=false,
    breakindent=0pt,
    escapeinside={{*@}{@*}},
  },%
  lefttitle=0pt,
  coltitle=black,
  colbacktitle=codegreen!20,
  fonttitle=\bfseries\sffamily\footnotesize,
  title={Example \thetcbcounter:  #2},
  #1,%
  borderline north={1pt}{14.4pt}{codegreen,dashed},
}

\newtcblisting[
auto counter,
]{code}{%
    listing only,
    breakable,
    top=0.2pt,
    bottom=0.2pt,
    colback=codegreen!10,
    colframe=codegreen,
    left=5pt,
    right=5pt,
      sharp corners,
    boxrule=0pt,
    bottomrule=0pt,
    toprule=0pt,
    enhanced jigsaw,
    listing options={%style=tcblatex,
%        numbers=left,
        numberstyle=\tiny\color{codeblue},
        moredelim={[is][keywordstyle]{@@}{@@}},
        basicstyle=\small\ttfamily,
        breaklines=true,
        breakautoindent=false,
        breakindent=0pt,
        escapeinside={{*@}{@*}},
    },%
    lefttitle=0pt,
    coltitle=codeblue,
    colbacktitle=codegreen!10,
%    fonttitle=\bfseries\footnotesize,
%    title={Example \thetcbcounter:  #2},
%   #1,%
%    borderline north={1pt}{14.4pt}{codegreen,dashed},
}

\newtcolorbox{bibbox}[1]{
      breakable,
      top=5pt,
      bottom=5pt,
      colback=codeblue!10,
      colframe=codeblue,
      left=5pt,
      right=5pt,
        sharp corners,
      boxrule=0pt,
      bottomrule=2pt,
      toprule=2pt,
      enhanced jigsaw,
        lefttitle=0pt,
        coltitle=black,
          fontupper=\small,%\ttfamily,
        colbacktitle=codeblue!20,
        fonttitle=\bfseries\footnotesize,
  title={\Cref{#1}},
        borderline north={1pt}{14.4pt}{codeblue,dashed},
}


\newtcolorbox{marker}[1][]{
enhanced,
  before skip=2mm,after skip=3mm,
  boxrule=0.4pt,left=5mm,right=2mm,top=1mm,bottom=1mm,
  colback=backcolour,
  colframe=yellow!20!black,
  sharp corners,rounded corners=southeast,arc is angular,arc=3mm,
  underlay={%
    \path[fill=tcbcol@back!80!black] ([yshift=3mm]interior.south east)--++(-0.4,-0.1)--++(0.1,-0.2);
    \path[draw=tcbcol@frame,shorten <=-0.05mm,shorten >=-0.05mm] ([yshift=3mm]interior.south east)--++(-0.4,-0.1)--++(0.1,-0.2);
    \path[fill=red!50!black,draw=none] (interior.south west) rectangle node[white]{\Huge\bfseries !} ([xshift=4mm]interior.north west);
    },
  drop fuzzy shadow,#1
  }



\tcbset{examplebox/.style={%
  boxrule=0pt,
  bottomrule=2pt,
  toprule=2pt,
  colframe=codeblue,
  colback=codegreen!10,
  coltitle=codegreen!10,%  coltitle=codeblue,
  bicolor,
  sharp corners,
  fontupper=\small\ttfamily,
  colbacklower=codeblue!10,
  fonttitle=\sffamily\bfseries,
  breakable,
  before skip=\baselineskip,
}}

\tcbset{versionboxstyle/.style={
  sharp corners,
  boxrule=0pt,
  toprule=1pt,
  coltitle=codegreen!10,
  colback=codeblue!10,
%  before skip=\baselineskip,
}}

\newtcolorbox{versionbox}{%
versionboxstyle,
}

\newtcolorbox{examplemanual}{%
examplebox,
  text only,
}



\newtcblisting{example}{%
  examplebox,
  %  sidebyside,
  listing and text,
}

\newcommand*{\printbib}[2][5em]{%
\begingroup
\begin{bibbox}{#2}
\begin{refsection}
\setlength{\labwidthsameline}{#1}
\nocite{#2}
\printbibliography[heading=none]
\end{refsection}
\end{bibbox}
\endgroup
}

\newcommand{\printbiball}[2][5em]{%
\begingroup
\setlength{\labwidthsameline}{#1}
\begin{bibbox}{#2}
\begin{itemize}
\begin{refsection}
\begin{footnotesize}
\nocite{#2}%
\item[English:]{\printbibliography[heading=none]}
\item[German:]\foreignlanguage{ngerman}{\printbibliography[heading=none]}
\item[Italian:]\foreignlanguage{italian}{\printbibliography[heading=none]}
\item[French:]\foreignlanguage{french}{\printbibliography[heading=none]}
\item[Spanish:]\foreignlanguage{spanish}{\printbibliography[heading=none]}
\end{footnotesize}
\end{refsection}
\end{itemize}%
\end{bibbox}
\endgroup
}




\newcommand\DAI{Deutsches Arch√§ologisches Institut\xspace}


%<*driver>
\RequirePackage[tightLists=false]{markdown}
\markdownSetup{rendererPrototypes={%
    link = {\href{#3}{#1}}%
}}
\GetFileInfo{\jobname.dtx}
%</driver>

\RequirePackage{hyperxmp}
\RequirePackage{hyperref}
\hypersetup{					% setup the hyperref-package options
  unicode       = true,
	pdftitle      = {bib\LaTeX-archaeologie},	% 	- title (PDF meta)
	pdfsubject    = {This citation-style covers the citation and bibliography rules of the \DAI.
                   Various options are available to change and adjust the outcome according to one's own preferences.
                   The style is compatible with the English, German, Italian, Spanish and French languages, since all bibstrings used are defined in each language.},% 	- subject (PDF meta)
	pdfauthor      = {Lukas C. Bossert, Johannes Friedl},	% 	- author (PDF meta)
	pdfauthortitle = {},
	pdfcopyright   = {This work may be distributed and/or modified under the
                    conditions of the LaTeX Project Public License, either version 1.3
                    of this license or (at your option) any later version.},
	pdfhighlight   = /N,
	pdfdisplaydoctitle = true,
	pdfdate        = {\the\year-\the\month-\the\day}
	pdflang        = {en},
	pdfcaptionwriter = {Lukas C. Bossert},
	pdfkeywords    = {biblatex, archaeology, humanities},
	pdfproducer={LuaLaTeX},
	pdflicenseurl  = {http://www.latex-project.org/lppl.txt},
	plainpages     = false,			% 	-
  colorlinks     = true, %Colours links instead of ugly boxes
  urlcolor       = codeblue, %Colour for external hyperlinks
  linkcolor      = codeblue, %Colour of internal links
  citecolor      = black, %Colour of citations
  linktoc        = page,
  pdfborder      = {0 0 0},			% 	-
	breaklinks     = true,			% 	- allow line break inside links
	bookmarksnumbered  = true,		%
	bookmarksopenlevel = 4,
	bookmarksopen  = true,		%
	final          = true
}
\RequirePackage{bookmark}

\crefformat{lstlisting}{#2example\ #1#3}
\Crefformat{lstlisting}{#2Example #1#3}
\crefmultiformat{lstlisting}{#2examples #1#3}{; #2#1#3}{; #2#1#3}{; #2#1#3}
\Crefmultiformat{lstlisting}{#2Examples #1#3}{; #2#1#3}{; #2#1#3}{; #2#1#3}
\Crefrangeformat{lstlisting}{#3Examples #1#4--#5#2#6}
\crefrangeformat{lstlisting}{#3examples #1#4--#5#2#6}

\pdfstringdefDisableCommands{%
  \def\lstinline#1{<#1>}
  \def\tex{TeX}%
  \def\etex{e-TeX}%
  \def\xetex{XeTeX}%
  \def\latex{LaTeX}%
  \def\xelatex{XeLaTeX}%
  \def\bibtex{BibTeX}%
  \def\lppl{LaTeX Project Public License}%
  \def\pdf{PDF}%
  \def\utf{UTF-8}%
  \def\\{}%
  \def\texttt#1{<#1>}%
  \def\marg#1{\{#1\}}%
  \def\oarg#1{[#1]}%
  \def\color#1#2{}%
  \def\env#1{<#1>}
  \def\cmd#1{#1}
}
